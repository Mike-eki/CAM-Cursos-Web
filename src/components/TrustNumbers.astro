---
import PlusIcon from "../icons/PlusIcon.astro";

interface Props {
    num: string;
    title: string;
    duration?: number;
}

const { num = "100", title, duration = 2000 } = Astro.props;

const targetNumber = parseInt(num, 10) || 100;
const animationDuration = Math.max(800, Math.min(4000, duration));

const uniqueId = `counter-${Math.random().toString(36).slice(2, 9)}`;
---

<aside data-target={targetNumber} data-duration={animationDuration}>
    <p>+<span class="counter-number" id={uniqueId}>0</span></p>
    <span class="name-title">{title}</span>
    <PlusIcon />
</aside>

<style>
    aside {
        width: -webkit-fill-available;
        width: -moz-available;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        border: 1px solid var(--color-bg-card-border);
        border-radius: 1rem;
        padding-inline: 0.5rem;
        padding-block: 0.75rem;
    }

    p {
        display: flex;
        align-items: center;
    }
    p,
    .counter-number {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        text-align: center;
    }
    span {
        font-size: 0.75rem;
        text-align: center;
    }

    @media screen and (min-width: 850px) {
        .counter-number {
            font-size: 2rem;
        }
        .name-title {
            font-size: 1.5rem;
        }
    }
</style>

<script>
    function animateNumber(el: HTMLElement, target: number, duration: number) {
        if (el.dataset.animating === "true") return;
        el.dataset.animating = "true";

        const start = 0;
        const startTime = performance.now();

        function update(time: number) {
            const elapsed = time - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // easing suave (ease-out cubic) → se siente más natural
            const eased = 1 - Math.pow(1 - progress, 3);

            const current = Math.floor(start + (target - start) * eased);
            el.textContent = current.toString();

            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                el.textContent = target.toString(); // aseguramos el número exacto al final
                el.dataset.animating = "false";
            }
        }

        requestAnimationFrame(update);
    }

    const observer = new IntersectionObserver(
        (entries, obs) => {
            entries.forEach((entry) => {
                if (!entry.isIntersecting) return;

                const aside = entry.target as HTMLElement;
                const target = parseInt(aside.dataset.target || "100", 10);
                const duration = parseInt(aside.dataset.duration || "2000", 10);
                const counterEl = aside.querySelector(
                    ".counter-number",
                ) as HTMLElement;

                if (counterEl && counterEl.textContent === "0") {
                    animateNumber(counterEl, target, duration);
                }

                obs.unobserve(aside);
            });
        },
        { threshold: 0.25 },
    );

    document.querySelectorAll("aside[data-target]").forEach((el) => {
        observer.observe(el);
    });
</script>
